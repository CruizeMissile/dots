#!/usr/bin/env bash

function usage()
{
    cat << 'EOF'
Usage: gdiff [options] base_file changed_file
Use git diff tool to find the difference between two files
Options:
  -h, --help, --usage,       This help screen
  -d, --word                 Diff using word diff and color
  -w, --ignore-whitespace    Ignore whitespace when comparing lines. This ignores differences even if one line has whitespace where the other line has none
  -l, --ignore-blank-lines   Ignore changes whose lines are all blank
  -b, --ignore-space-change  Ignore changes in amount of whitespace. This ignores whitespace at line end, and considers all other sequences of one or more whitespace characters to be equivalen
EOF
    exit $1
}

function parse_arguments()
{
    # This is a way to parse opts and args: https://stackoverflow.com/a/40190976
    # This is how to parse long options with getopts: https://stackoverflow.com/a/12523979
    parse_args=()
    local optspec=":hdwlb-"
    while [ $# -gt 0 ] ; do
        unset OPTIND ; unset OPTIND
        while getopts $optspec OPTION ; do
            case "$OPTION" in 
                h) usage 0                                  ;;
                d) git_arguments+=('--color-words')         ;;
                w) git_arguments+=('-w')                    ;;
                l) git_arguments+=('--ignore-blank-lines')  ;;
                b) git_arguments+=('--ignore-space-change') ;;
                -)
                    [ $OPTIND -ge 1 ] && optind=$(expr $OPTIND - 1) || optind=$OPTIND
                    eval OPTION="\$$optind"
                    OPTARG=$(echo $OPTION | cut -d'=' -f2)
                    OPTION=$(echo $OPTION | cut -d'=' -f1)
                    case $OPTION in
                        --help) usage 0                                                 ;;
                        --usage) usage 0                                                ;;
                        --word) git_arguments+=('--color-words')                        ;;
                        --ignore-whitespace) git_arguments+=('-w')                      ;;
                        --ignore-blank-lines) git_arguments+=('--ignore-blank-lines')   ;;
                        --ignore-space-change) git_arguments+=('--ignore-space-change') ;;
                        *) echo "Invalid option $OPTION $OPTARG" && usage 1             ;;
                    esac
                    OPTIND=1 ; shift ;;
                \?) echo "Invalid option $OPTION $OPTARG" && usage 1 ;;
            esac
        done
        shift $((OPTIND-1)) ; parse_args+=($1) ; shift
    done
}

function main()
{
    # If no arguments are passed then print usage and exit
    [[ $# -eq 0 ]] && usage && exit 0

    parse_arguments "$@"

    [ ${#parse_args[@]} -ne 2 ] && echo "Two files must be specified!" && usage && exit 1

    git diff --no-index ${git_arguments[@]} -- "${parse_args[@]}"
    exit $?
}

main "$@"
